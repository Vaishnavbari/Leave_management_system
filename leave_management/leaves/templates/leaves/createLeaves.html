{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <title>Leave Management System</title>
    <!-- MDB icon -->
    <link rel="icon" href="img/mdb-favicon.ico" type="image/x-icon" />
   
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" />
    <!-- Google Fonts Roboto -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" />
    <!-- MDB -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />

    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <style>
        .editable {
            border: 2px solid black; 
            padding: 5px;
        }
        body, html {
            overflow: hidden;
            margin: 0;
            padding: 0;
        }
        .container-fluid {
            overflow: hidden;
            padding: 0;
        }
        .table-fit {
            width: 100%;
            table-layout: fixed;
        }
    
        .table-fit th, .table-fit td {
            word-wrap: break-word;
        }
        .table-responsive-leave {
            display: table;
        }

    </style>
</head>

<body class="main">
    <center>
      <header>
            <h3 style="color: black;">
                Leave Management System
            </h3>
        </header>
        <hr>
        <br> 
        <div id="errorMessages" style="color:red"></div>

        <form style="background:none" method="POST" id="projectForm">
            {% csrf_token %}
            <div class="form-row align-items-center" style="display: flex; flex-direction: column;">
                <div class="col-sm-3 my-1">
                    <label class="sr-only" for="inlineFormInputName">Leave Type</label>
                    <input type="text" class="form-control" placeholder="Add Leave" id="typeData" name="type">
                </div>
                <span id="type" style="color:red"></span>
                <br>
                <div class="col-sm-3 my-1">
                    <label class="sr-only" for="inlineFormInputName">Description</label>
                    <textarea type="text" class="form-control" placeholder="Add Description" type="DescriptionData" name="description" style="height:10rem;"></textarea>
                </div>
                <span id="description" style="color:red"></span>

                <div class="col-auto my-1">
                    <button class="btn btn-primary btn-block fa-lg gradient-custom-2 mb-3" type="submit" id="submit">ADD</button>
                </div>
            </div>
        </form>
    </center>
    <div class="container-fluid" style="margin-top: 2rem;">
        <div class="table-responsive-leave" style="margin:2rem">
            <table class="table table-sm table-fit " style="color:black; background-color: white !important;  text-align: center !important;">
                <thead style="background:none; color:black">
                    <tr style="background:none color:black">
                        <th scope="col" class="col-1"  style="width:5%">ID</th>
                        <th scope="col" class="col-3">Leave Type</th>
                        <th scope="col" class="col-3" style="width:40%">Description</th>
                        <th scope="col" class="col-1" style="width:10%">Edit</th>
                        <th scope="col" class="col-1" style="width:10%">Delete</th>
                        <th scope="col" class="col-1" style="width:10%">Status</th>
                    </tr>
                </thead>
                <tbody id="genrate">
                    {% include "leaves/leavedata.html" %}
                </tbody>
            </table>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script>
      $(document).ready(function() {
        $(document).on('submit', '#projectForm', function(e) {
          e.preventDefault();
          const formData = new FormData(this);
          var url = 'http://127.0.0.1:8000/leave/add';
          var accessToken = localStorage.getItem('access_token');
          var refreshToken = localStorage.getItem('refresh_token');
          fetch(url, {
              method: 'POST',
              headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Authorization': `Bearer ${refreshToken}`, 
                'refresh_token': refreshToken
            },
              body: formData
          })
          .then(response => response.json())
          .then(data => {
              $('#type').html('');
              $('#description').html('');
              $('#errorMessages').html('');
              if (data.errors && data.errors.errors) {
                  for (const key in data.errors.errors) {
                      if (key === "type") {
                          const typeError = data.errors.errors.type ? data.errors.errors.type[0] : "";
                          $('#type').html(typeError);
                      } else if (key === "description") {
                          const descriptionError = data.errors.errors.description ? data.errors.errors.description[0] : " ";
                          $('#description').html(descriptionError);
                      } else {
                          const error = data.errors.errors[key] ? data.errors.errors[key][0] : " ";
                          $('#errorMessages').html(error);

                      }
                  }
              }

              if (data.errors && data.errors === "non_field_errors") {
                  $('#errorMessages').html(data.errors);
              }

              if (data.status == "success") {
                  Toastify({
                    text: data.message,
                    duration: 3000,
                           gravity: "top",
                           position: "right",
                           stopOnFocus: true,
                           style: {
                               width:"300px",
                               background: "#28a745",
                               color: "#fff",
                           },
                           onClick: function () {},
                       }).showToast();
                  loadTableData () 
              }
          })
          .catch(error => {
              console.error('Error:', error);
          });
        });
      });

      function loadTableData () {
        var count = 0
        var accessToken = localStorage.getItem('access_token');
        var refreshToken = localStorage.getItem('refresh_token');
        $.ajax({
            url: `http://127.0.0.1:8000/leave/add/${count}`,
            
            type: "GET",
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Authorization': `Bearer ${refreshToken}`, 
                'refresh_token': refreshToken
            },
            success: function (response) {
            console.log(response)
                $("#genrate").html(response);
                count++;
                $('#projectForm')[0].reset();

            },
            error: function (xhr, status, error) {
              console.error(error);
            },
          });
        }

   // delete leave  
   $(document).on('click', '.delete', function (e) {
        var id = $(this).attr("id");
        console.log(id);
        var url = `http://127.0.0.1:8000/leave/delete/${id}`
        var accessToken = localStorage.getItem('access_token');
        var refreshToken = localStorage.getItem('refresh_token');
        $.ajax({
            url: url,
            type: "DELETE",
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Authorization': `Bearer ${refreshToken}`, 
                'refresh_token': refreshToken
            },
            success: function (response) {
                    Toastify({
                     text: response.message,
                     duration: 3000,
                            gravity: "top",
                            position: "right",
                            stopOnFocus: true,
                            style: {
                                width:"300px",
                                position:"right",
                                background: "#28a745",
                                color: "#fff",
                            },
                            onClick: function () {},
                        }).showToast();
                if (response.status=="success"){
                    loadTableData();
                }
            },
            error: function (xhr, status, error) {
                if (xhr.status === 400) {
                    Toastify({
                        text: xhr.responseJSON.errors.errors.non_field_errors 
                              ? "Something went Wrong !!!!" 
                              : "An unexpected error occurred.",
                        duration: 3000,
                        gravity: "top",
                        position: "right",
                        stopOnFocus: true,
                        style: {
                            width: "300px",
                            background: "red",
                            color: "#fff",
                        },
                        onClick: function () {},
                    }).showToast();
                    
                        }
                else if (xhr.status === 404){
                    Toastify({
                        text:xhr.responseJSON.message ,
                        duration: 3000,
                                gravity: "top",
                                position: "right",
                                stopOnFocus: true,
                                style: {
                                    width:"300px",
                                    position:"right",
                                    background: "red",
                                    color: "#fff",
                                },
                                onClick: function () {},
                            }).showToast();
                            loadTableData () 
                        }
                else {
                    Toastify({
                        text: "Something Went Wrong...!!!",
                        duration: 3000,
                               gravity: "top",
                               position: "right",
                               stopOnFocus: true,
                               style: {
                                   width:"300px",
                                   position:"right",
                                   background: "red",
                                   color: "#fff",
                               },
                               onClick: function () {},
                           }).showToast();
                           loadTableData () 
                        }
                    },
             });
    });
   
    // edit leave
    $(document).on('click', '.edit', function (e){
        var button = $(this);
        console.log(button.html())
        var id = button.attr("id");
        var tds = button.closest('tr').find("td");
        if (button.html().trim() === 'Edit') {
            tds.eq(0).addClass('editable').attr('contenteditable', true);
            tds.eq(1).addClass('editable').attr('contenteditable', true);
            button.html('Save');
        } 
        else {
            var data = {
                type: tds.eq(0).text(),
                description: tds.eq(1).text()
            };
        var url = `http://127.0.0.1:8000/leave/update/${id}`
        var accessToken = localStorage.getItem('access_token');
        var refreshToken = localStorage.getItem('refresh_token');
        $.ajax({
            url: url,
            type: "PUT",
            data: JSON.stringify(data),
            contentType: "application/json",
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Authorization': `Bearer ${refreshToken}`, 
                'refresh_token': refreshToken
            },
            success: function (response) {
                   button.html('Edit');
                   tds.eq(0).removeClass('editable');
                   tds.eq(1).removeClass('editable');
                   tds.eq(0).attr('contenteditable', false); 
                   tds.eq(1).attr('contenteditable', false);
                   if (response.message) {
                    Toastify({
                      text: response.message,
                      duration: 3000,
                             gravity: "top",
                             position: "right",
                             stopOnFocus: true,
                             style: {
                                 width:"300px",
                                 background: "#28a745",
                                 color: "#fff",
                             },
                             onClick: function () {},
                         }).showToast();
                         loacation.reload()
                }

            },
            error: function (xhr, status, error) {
                if (xhr.status === 400) {
                    Toastify({
                        text: xhr.responseJSON.errors.errors.non_field_errors 
                              ? "Something went Wrong !!!!" 
                              :"This field is required",
                        duration: 3000,
                        gravity: "top",
                        position: "right",
                        stopOnFocus: true,
                        style: {
                            width: "300px",
                            background: "red",
                            color: "#fff",
                        },
                        onClick: function () {},
                    }).showToast();
                        }
                else if (xhr.status === 404){
                    Toastify({
                        text:xhr.responseJSON.message ,
                        duration: 3000,
                                gravity: "top",
                                position: "right",
                                stopOnFocus: true,
                                style: {
                                    width:"300px",
                                    position:"right",
                                    background: "red",
                                    color: "#fff",
                                },
                                onClick: function () {},
                            }).showToast();
                            loadTableData () 
                        }
                else {
                    Toastify({
                        text: "Something Went Wrong...!!!",
                        duration: 3000,
                               gravity: "top",
                               position: "right",
                               stopOnFocus: true,
                               style: {
                                   width:"300px",
                                   position:"right",
                                   background: "red",
                                   color: "#fff",
                               },
                               onClick: function () {},
                           }).showToast();
                           loadTableData () 
                        }
                },
         });
        }
     })

    // update leave status
    $(document).on('click', '.status', function(e) {
            var id = $(this).attr("id").replace("Td-", "");
            var statusIcon = $(this);
            var url = `http://127.0.0.1:8000/leave/update/leave-type-status/${id}`
            var accessToken = localStorage.getItem('access_token');
            var refreshToken = localStorage.getItem('refresh_token');
            $.ajax({
                url: url,
                type: "PUT",
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Authorization': `Bearer ${refreshToken}`, 
                    'refresh_token': refreshToken
                },
                success: function(response) {
                    Toastify({
                        text: response.message,
                        duration: 3000,
                        gravity: "top",
                        position: "right",
                        stopOnFocus: true,
                        style: {
                            width:"300px",
                            background: "#28a745",
                            color: "#fff",
                               },
                               onClick: function () {},
                           }).showToast();
                    loadTableData();
                },
                error: function(xhr, status, error) {
                    if (xhr.status === 400) {
                        Toastify({
                            text: xhr.responseJSON.errors.errors.non_field_errors[0],
                            duration: 3000,
                                   gravity: "top",
                                   position: "right",
                                   stopOnFocus: true,
                                   style: {
                                       width:"300px",
                                       position:"right",
                                       background: "red",
                                       color: "#fff",
                                   },
                                   onClick: function () {},
                               }).showToast();
                               loadTableData () 
                            }
                    else if (xhr.status === 404){
                        Toastify({
                            text:xhr.responseJSON.message ,
                            duration: 3000,
                                    gravity: "top",
                                    position: "right",
                                    stopOnFocus: true,
                                    style: {
                                        width:"300px",
                                        position:"right",
                                        background: "red",
                                        color: "#fff",
                                    },
                                    onClick: function () {},
                                }).showToast();
                                loadTableData () 
                            }
                    else {
                        Toastify({
                            text: "Something Went Wrong...!!!",
                            duration: 3000,
                                   gravity: "top",
                                   position: "right",
                                   stopOnFocus: true,
                                   style: {
                                       width:"300px",
                                       position:"right",
                                       background: "red",
                                       color: "#fff",
                                   },
                                   onClick: function () {},
                               }).showToast();
                               loadTableData () 
                        }
                },
            });
        });
    </script>
</body>
</html>
