{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <title>Leave Management System</title>
    <!-- MDB icon -->
    <link rel="icon" href="img/mdb-favicon.ico" type="image/x-icon" />
   
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" />
    <!-- Google Fonts Roboto -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" />
    <!-- MDB -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <style>
      table tr {
        border: solid black 1px;
      }
        table, th, td, thead, tbody, tr {
            background-color: transparent !important;
            color: black !important;
          
        }
        .main{
  
          height:100vh;
          width:100vw;
          {% comment %} background-image: url("{% static 'css/employee.png' %}"); {% endcomment %}
          background-size:cover;
          
        
          }
          .editable {
            border: 2px solid black; /* Add your desired border style */
            padding: 5px; /* Optional: Add padding for better appearance */
        }
    </style>
</head>

<body class="main">
    <center>
      <header>
            <h3 style="color: black;">
                Leave Management System
            </h3>
        </header>
        <hr>
        <br> 
        <div id="errorMessages" style="color:red"></div>

        <form style="background:none" method="POST" id="projectForm">
            {% csrf_token %}
            <div class="form-row align-items-center">
                <div class="col-sm-3 my-1">
                    <label class="sr-only" for="inlineFormInputName">Leave Type</label>
                    <input type="text" class="form-control" placeholder="Add Leave" id="typeData" name="type">
                </div>
                <span id="type" style="color:red"></span>
                <div class="col-sm-3 my-1">
                    <label class="sr-only" for="inlineFormInputName">Description</label>
                    <textarea type="text" class="form-control" placeholder="Add Description" type="DescriptionData" name="description" style="height:10rem;"></textarea>
                </div>
                <span id="description" style="color:red"></span>

                <div class="col-auto my-1">
                    <button class="btn btn-primary btn-block fa-lg gradient-custom-2 mb-3" type="submit" id="submit">ADD</button>
                </div>
            </div>
        </form>
    </center>
    <div class="table-responsive" style="margin:2rem">
        <table class="table table-sm" style="color:black; background-color: white !important;">
            <thead style="background:none; color:black">
                <tr style="background:none color:black">
                    <th scope="col">id</th>
                    <th scope="col">Leave Type</th>
                    <th scope="col">Description</th>
                    <th scope="col">Edit</th>
                    <th scope="col">Delete</th>
                    <th scope="col">Status</th>
                </tr>
            </thead>
            <tbody id="genrate">
                {% include "leaves/leavedata.html" %}
            </tbody>
        </table>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script>
      $(document).ready(function() {
        $(document).on('submit', '#projectForm', function(e) {
          e.preventDefault();
          const formData = new FormData(this);
          var url = 'http://127.0.0.1:8000/leave/add';
          fetch(url, {
              method: 'POST',
              headers: {
                  'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
              },
              body: formData
          })
          .then(response => response.json())
          .then(data => {
              $('#type').html('');
              $('#description').html('');
              $('#errorMessages').html('');
              
              if (data.errors && data.errors.errors) {
                  for (const key in data.errors.errors) {
                      if (key === "type") {
                          const typeError = data.errors.errors.type ? data.errors.errors.type[0] : "";
                          $('#type').html(typeError);
                      } else if (key === "description") {
                          const descriptionError = data.errors.errors.description ? data.errors.errors.description[0] : " ";
                          $('#description').html(descriptionError);
                      } else {
                          const error = data.errors.errors[key] ? data.errors.errors[key][0] : " ";
                          $('#errorMessages').html(error);
                      }
                  }
              }

              if (data.errors && data.errors === "non_field_errors") {
                  $('#errorMessages').html(data.errors);
              }

              if (data.message) {
                  $('#errorMessages').html(data.message);
                  loadTableData () 
              }
          })
          .catch(error => {
              console.error('Error:', error);
          });
        });
      });


      function loadTableData () {
        var count = 0
          $.ajax({
            url: `http://127.0.0.1:8000/leave/add/${count}`,
            
            type: "GET",
            
            success: function (response) {
           
                $("#genrate").html(response);
                count++;
                $('#projectForm')[0].reset();

            },
            error: function (xhr, status, error) {
              console.error(error);
            },
          });
        }

   // delete leave  
   $(document).on('click', '.delete', function (e) {
        var id = $(this).attr("id");
        console.log(id);
        var url = `http://127.0.0.1:8000/leave/delete/${id}`
        $.ajax({
            url: url,
            type: "DELETE",
            success: function (response) {
                    Toastify({
                     text: response.message,
                     duration: 3000,
                            gravity: "top",
                            position: "left",
                            stopOnFocus: true,
                            style: {
                                width:"300px",
                                position:"right",
                                background: "#28a745",
                                color: "#fff",
                            },
                            onClick: function () {},
                        }).showToast();
                if (response.status=="success"){
                    loadTableData();
                }
            },
            error: function (xhr, status, error) {
                    console.error(error);
                    },
             });
    });
   
    // edit leave
    $(document).on('click', '.edit', function (e) {
        var id = $(this).attr("id");
        var tds = $(this).closest('tr').find("td");
        tds.eq(0).addClass('editable');
        tds.eq(1).addClass('editable');
        tds.eq(0).attr('contenteditable', true); 
        tds.eq(1).attr('contenteditable', true);
        var button = $(this); 
        button.html('Save');
        var data = {
            type: tds[0].innerText, 
            description: tds[1].innerText
        };
        console.log(data)
        var url = `http://127.0.0.1:8000/leave/update/${id}`
        $.ajax({
            url: url,
            type: "PUT",
            data: JSON.stringify(data),
            contentType: "application/json",
            success: function (response) {
                   button.html('Edit');
                   tds.eq(0).removeClass('editable');
                   tds.eq(1).removeClass('editable');
                   tds.eq(0).attr('contenteditable', false); 
                   tds.eq(1).attr('contenteditable', false);
                   console.log(response);

            },
            error: function (xhr, status, error) {
                console.error(error);
                },
                });
        });

        
      
    </script>
</body>
</html>
